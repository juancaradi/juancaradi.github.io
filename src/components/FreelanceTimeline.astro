---
import freelanceData from '../data/freelance.json';
import { ui, defaultLang } from '../i18n/ui';

interface Props {
  lang: string;
  year: number; // ✨ AHORA FILTRAMOS POR AÑO
}

const { lang = 'es', year } = Astro.props;
const t = ui[lang as keyof typeof ui] || ui[defaultLang];

// 1. Filtrar por año y ordenar
const yearData = freelanceData
  .filter(item => new Date(item.date).getFullYear() === year)
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

// 2. Helper para saber si cambió el mes
let lastMonth = -1;

const getMonthHeader = (dateStr: string) => {
  const date = new Date(dateStr);
  const currentMonth = date.getMonth();
  
  if (currentMonth !== lastMonth) {
    lastMonth = currentMonth;
    // Retornamos el nombre del mes (Enero, Febrero...)
    return date.toLocaleDateString(lang, { month: 'long', year: 'numeric' });
  }
  return null;
};
---

{yearData.length > 0 ? (
  <div class="timeline">
    {yearData.map((item) => {
      const monthHeader = getMonthHeader(item.date);
      
      return (
        <>
          {/* ✨ ENCABEZADO DE MES (Si corresponde) */}
          {monthHeader && (
            <div class="month-separator">
              <span class="month-label">{monthHeader}</span>
            </div>
          )}

          <div class="timeline-item fade-in">
            {/* ... (EL RESTO DE TU CÓDIGO DE TIMELINE IGUAL QUE ANTES) ... */}
            {/* Solo quitamos la columna de fecha lateral porque ahora tenemos encabezados de mes */}
            
            <div class="timeline-dot"></div>

            <div class="timeline-content card-glass">
              <div class="card-header">
                <span class="badge-subject">{item.subject[lang]}</span>
                <span class="badge-type">{item.type[lang]}</span>
                <span class="date-inline">{new Date(item.date).toLocaleDateString(lang, { day: 'numeric', timeZone: 'UTC' })}</span>
              </div>
              
              <h3 class="card-title">{item.title[lang]}</h3>
              <p class="card-desc">{item.description[lang]}</p>

              <div class="resources-list">
                {item.resources.map(res => (
                  res.url ? (
                    <a href={res.url} class={`resource-pill ${res.tool.toLowerCase()}`} target="_blank" rel="noopener noreferrer">
                      <span class="pill-text">{res.name}</span>
                      <svg class="action-icon" viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    </a>
                  ) : (
                    <div class={`resource-pill disabled ${res.tool.toLowerCase()}`}>
                      <span class="pill-text">{res.name}</span>
                      <svg class="action-icon" viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    </div>
                  )
                ))}
              </div>
            </div>
          </div>
        </>
      );
    })}
  </div>
) : (
  <div class="empty-state">No hay registros para este año.</div>
)}

<style>
  /* --- ESTILOS DE TIMELINE (Iguales, con ajuste para el separador) --- */
  .timeline { position: relative; max-width: 800px; margin: 20px auto; padding-left: 20px; }
  .timeline::before { content: ''; position: absolute; left: 24px; top: 0; bottom: 0; width: 2px; background: var(--border); border-radius: 2px; z-index: 0; }

  /* Mes Separador */
  .month-separator { position: relative; margin: 40px 0 20px 0; z-index: 2; display: flex; align-items: center; }
  .month-label { 
    background: var(--bg); color: var(--link); border: 1px solid var(--link); 
    padding: 5px 15px; border-radius: 20px; font-weight: 700; text-transform: capitalize; font-size: 0.9rem;
  }

  .timeline-item { position: relative; margin-bottom: 30px; display: flex; align-items: flex-start; padding-left: 40px; }
  
  /* El punto ahora está alineado a la línea vertical */
  .timeline-dot { position: absolute; left: 19px; top: 20px; width: 12px; height: 12px; background: var(--link); border: 3px solid var(--bg); border-radius: 50%; z-index: 10; }

  .timeline-content { flex-grow: 1; background: var(--code-bg); border: 1px solid var(--border); border-radius: 16px; padding: 20px; transition: all 0.3s ease; }
  .timeline-content:hover { transform: translateY(-2px); border-color: var(--link); }

  .card-header { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; align-items: center; }
  .date-inline { margin-left: auto; font-size: 0.8rem; color: var(--muted); font-weight: 600; }
  
  /* Badges y Pills (Mismos estilos de antes...) */
  .badge-subject { font-size: 0.75rem; font-weight: 700; color: var(--color-active); background: rgba(16, 185, 129, 0.1); padding: 4px 10px; border-radius: 99px; }
  .badge-type { font-size: 0.75rem; color: var(--muted); border: 1px solid var(--border); padding: 4px 10px; border-radius: 99px; }
  .card-title { margin: 0 0 8px 0; font-size: 1.2rem; color: var(--text); }
  .card-desc { font-size: 0.95rem; color: var(--muted); margin-bottom: 16px; line-height: 1.5; }
  .resources-list { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px; }
  .resource-pill { display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; text-decoration: none; border: 1px solid transparent; }
  
  /* ... (Copia aquí el bloque de colores del archivo anterior: .resource-pill.python, etc.) ... */
  .resource-pill.pdf { background: rgba(220, 38, 38, 0.1); color: #dc2626; border-color: rgba(220, 38, 38, 0.2); }
  /* ... etc ... */
</style>