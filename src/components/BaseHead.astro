---
// src/components/BaseHead.astro
interface Props {
  title: string;
  description: string;
  lang: string;
}

const { title, description, lang } = Astro.props;
const ogImage = new URL('/img/og-image.jpg', Astro.url);
---

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<meta name="generator" content={Astro.generator} />

<!-- ✅ Orden correcto -->
<meta name="color-scheme" content="light dark" />

<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<meta property="og:type" content="website" />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={ogImage} />

<!-- ✅ Theme-color dinámico (iOS address bar) -->
<meta name="theme-color" content="#ffffff" data-dynamic-theme-color />

<script is:inline>
  (() => {
    const root = document.documentElement;

    const setThemeColor = (theme) => {
      const meta = document.querySelector('meta[data-dynamic-theme-color]');
      if (!meta) return;
      meta.setAttribute('content', theme === 'dark' ? '#232323' : '#ffffff');
    };

    const resolveTheme = () => {
      let saved = null;
      try { saved = localStorage.getItem("theme"); } catch (_) {}

      const prefersDark =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      return (saved === "dark" || (!saved && prefersDark)) ? "dark" : "light";
    };

    const applyTheme = () => {
      const isSwapping = root.classList.contains('is-swapping');

      // ✅ DURANTE SWAP: NO cambies el tema (evita micro-frame blanco en iOS)
      if (isSwapping) {
        const cur = root.getAttribute("data-theme") === "dark" ? "dark" : "light";
        root.style.backgroundColor = cur === "dark" ? "#232323" : "#ffffff";
        setThemeColor(cur);
        return;
      }

      const next = resolveTheme();

      if (root.getAttribute("data-theme") !== next) {
        root.setAttribute("data-theme", next);
      }

      // ✅ Fondo “pintado” desde el primer frame (extra blindaje)
      root.style.backgroundColor = next === "dark" ? "#232323" : "#ffffff";
      setThemeColor(next);
    };

    // 1) inmediato
    applyTheme();

    // 2) en swaps
    document.addEventListener('astro:after-swap', applyTheme);

    // 3) si cambia el sistema (auto), refresca (opcional pero útil)
    try {
      const mq = window.matchMedia("(prefers-color-scheme: dark)");
      if (mq && mq.addEventListener) mq.addEventListener("change", applyTheme);
    } catch (_) {}
  })();
</script>

<style>
  /* ✅ NO forzar blanco: deja que el browser use color-scheme y el CSS global */
  html { background: transparent; }

  /* ✅ Anti-flash real: si el sistema prefiere dark, el primer frame ya es oscuro */
  @media (prefers-color-scheme: dark) {
    html { background-color: #232323; }
  }

  /* ✅ Si ya quedó data-theme, gana eso */
  html[data-theme="dark"] { background-color: #232323; }
  html[data-theme="light"] { background-color: #ffffff; }
</style>
